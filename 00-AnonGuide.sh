#!/bin/bash

anon(){
cat <<EOF
                                ,▄▄#▓▓▓▓▀▀▀▀▀▀▀▀▓▓▓▓▄▄▄,
                           ▄#▓█▀▀╙└                  .╙▀▀█▓▄▄,
                       ▄▓█▀╙                                ╙▀█▓▄,
                   .▄█▀╙                                        ╙▀█▄,
                 ▄▓▀╙                                              ╙▀█▄
               ▄█▀                                                    ▀█▓
             ▄█▀        .             .╓╓╓╔╔╔╔╔╓╓,             .        ╙█▓
           ▄█▀      ▄#▓▀        .╔∩└││∩`.∩ () │,`└∩`└N╔,        ╙▓▓▄      ▀█▄
          ▓█`  .▄∩#██▀       ╓∩`  ┌∩`   ∩  ()  │   `7╓  `7╔       ▀██▓º╗,   ▀█,
        ┌█▀   ▓█ ███Ñb    ╓∩`└7╔╓∩     │   ()   ∩    `N╓╔∩└`7╓    (▄▀██,▀█,  ▀█▄
       ╓█▀ ..██Γ╫▀▄#█   ╓∩     .∩ `└ª∩∩∩╓╓▄M▓▓▄┌│∩∩ª└` │,     └╔   ▀▓▄▀▓└██,, ╙█▄
      ┌█▀ ▄▌▐██.#██▀  .∩      (∩      │  ▀█∩Γ███ │      │,      ⌠,  ╙██▓,██▌║▄ ╙█▄
      █▌ ▐█▌▐█▓█▀▐   (∩      .∩      (∩    (@█▀  │,      │,      └╔   ▄▀███▌▐█▌ ╙█
     ╫█  ███(█▀▄▓▌  (∩└∩w╓,  │       (     (▌     ∩       │ ..╓o∩└└∩  ║▓▄╙█Γ╫██  █▌
     █Ñ  ███"▄██▀  (∩       │∩└7∩wo╓╓│╓....#▓,...,∩╓╓w∩∩∩└│∩       └∩  ▀██▄"███  └█⌐
    ║█ .▒▐██╫██╩   ∩        │        │     ▀▀     │        ⌠        │   ╙█████▌⌠▄ █▌
    █▌ ║█ ▀██▀.█  (∩        ∩        │    «ⁿⁿ«    │        │        │∩  █,╙███ ╫▌ ║█
    █▌ ║█▌ █Ö╓█▌  │         ∩        ∩┌#"╙▀██▀╙`▓▄│        │         ∩  ║█▄└█ ╔█▌ ▐█
    █▌  ██▌└#██─  │"```````└∩```"▄▄▄▓███  ╓██▄  ███▓▄▄▄````│∩````````∩   ██▌└#██∩ ▐█
    █▌ ┌▀██M██▌╔  (,        ∩╫█████████▌   ╫▌   j█████████▓│         ∩  ╕▐██╓███, ▐█
    ║█ ║,╙████ █▄  ∩        N██████████▌   ██⌐  ╓██████████M        │  ╓█ ██▓█▀ ▌ █▌
    └█⌐╙█▄ ▀█▌ ██  │,       ▐███████████,  ██b  ███████████▌        ∩  ██▄╙█▀ ▄█▌ █▀
     █▌ ▀██▄└M║██   │  ,╓∩∩┘█████████████,j██b.█████████████7½∩╓,  ∩   ██▌⌠Ö▄██▀ ║█
     └█▄ └███▄╙██⌐║▄ │,     ██████████████▓█████████████████     .∩ ╓▌ ██▌▄███╙ ┌█É
      ╙█, ▄╙▀████b└█▌ └╓   (████████████████████████████████Γ   ┌∩ #█Γ╒█████▀╓  █▌
       ▀█,└█▄ ╙▀██ ██▌ `U, ▐████████████████████████████████▌ .∩` ╫██ ██▀╙ ▄▓╩ ██
        ▀█, ▀██▄▄▄ⁿ╙██▌¥▄`7╫█████████████████████████████████∩"▄M╔██▌┘╙▄▄▓██'.█▀
         ╙█▄  ▀████▓╬██▄▀█▄██████████████████████████████████▄█▀╓██▌#████▀. ╓█▀
           ▀█, '▄╙▀▀████▄╙████████████████████████████████████▀▄████▀▀▀▄∩  ▓█"
            ╙█▓  ▀▓▓▄▄▄▄▄▄▄╠▀██████████████████████████████▀▀▄▄▄▄▄▄▄#▓▀' ▄█▀
              ▀█▄  └▀▀████████▀▀▀██████████████████████╙▀▀████████▀▀└  ▄█▀
                ╙█▓▄  4▄▄╓,╓▄▄#▓████████████████████████▓▄▄▄╓,╓▄▄R  ╓▓█▀
                  '▀█▓▄ ╙▀▀▀███▀▀██████████████████████▀▀████▀▀╙ ╓#█▀"
                     └▀█▓▄,      ██████████████████████      .▄▓█▀└
                         ╙▀▀▓▄▄,.██████████████████████▄,▄#▓█▀╙
                              ╙▀▀▀█████████████████████▀▀╙
    
EOF
sleep 1.5
}

DebianStarter(){

echo "IF you REALLY are Using Anon-Guide...
well.... you need answer this question..
  -- What CHAPTER have you walked? -- 
1 - Chapter 2A
2 - Chapter 2B" 
read CHPTROPT

if [ "$CHPTROPT" == "1" ];then
 echo "Are you Using this METHOD: Debian (Encrypted Boot USB)" && sleep 1
elif [ "$CHPTROPT" == "2" ];then
 echo "Are you Using this METHOD: Debian (USB / Internal HDD) + BootKey (USB)" && sleep 1
sudo dd if=/dev/urandom of=/keyfile bs=512 count=16
sudo YourDeviceName=$(awk '{print $2}' /etc/crypttab) ### NEEED WORK ON THIS awk ....
sudo sed -i 's+none luks+/boot/keyfile.gpg luks,keyscript=/lib/cryptsetup/scripts/decrypt_gnupg+' /etc/crypttab
sudo cryptsetup luksAddKey /dev/$YourDeviceName /keyfile
 echo "Set Password... Same has BOOT" && sleep 2
sudo gpg -c --cipher-algo AES256 /keyfile 
sudo mv /keyfile.gpg /boot/keyfile.gpg 
sudo update-initramfs -u
sudo cryptsetup luksKillSlot /dev/$YourDeviceName 0 --key-file /keyfile
sudo shred -n 30 -uv /keyfile 

 echo "Chapter 2C Finished!!" 
 read -p "Press <Enter> key to continue..."
else
 echo "FAIL COCKSUCKER" && exit 0
fi

echo "Disable SOUNd"
gnome-control-center sound
read -p "Press <Enter> key to continue..."
echo "Disable IPv6"
gnome-control-center network
read -p "Press <Enter> key to continue..."
echo "Disable History & Usage + Purge Trash"
gnome-control-center privacy
read -p "Press <Enter> key to continue..."

echo "net.ipv4.tcp_timestamps = 0" | sudo tee -a  /etc/sysctl.d/tcp_timestamps.conf
sudo sysctl -p /etc/sysctl.d/tcp_timestamps.conf

if [ -f /etc/systemd/system/bluetooth.target.wants/bluetooth.service ]
then
 sudo systemctl stop bluetooth.service 
 sudo systemctl disable bluetooth.service
 echo "Bluetooth Service disabled!" && sleep 1
else
 echo "No bluetooth service" && sleep 1
fi

sudo apt-get install ufw
sudo cp /etc/ufw/before.rules /etc/ufw/before.rules.original
sudo sed -i /etc/ufw/before.rules -e '/# ok icmp codes for INPUT/,/# allow dhcp client to work/s/ACCEPT/DROP/g'
sudo ufw enable

sudo apt-get install tor apt-transport-tor
sudo cp /etc/apt/sources.list /etc/apt/sources.list.original 
sudo sed -i 's|https|tor+https|g' /etc/apt/sources.list
echo "deb tor+https://deb.debian.org/debian-security $ID_CODENAME/updates main contrib non-free" | sudo tee -a /etc/apt/sources.list
sudo apt-get update
sudo apt-get install -y linux-headers-$(dpkg --print-architecture) software-properties-common

read -p "IF you want config a PANIC PASSWORD write: OK " PAMDUR
if [[ "$PAMDUR" -eq "OK" ]]; then
 echo "Lets Config a PANIC PASSWORD ;)"
 sleep 2
 sudo apt install -y git make build-essential libpam0g-dev libssl1.1 libssl-dev
 sudo torsocks git clone https://github.com/Lqp1/pam_duress
# apt install libcurl4-openssl-dev libpam-cracklib ## check if REALLY needed installed..
 sudo cd pam_duress
 sudo make
 sudo make install
 sudo make clean
 sudo cp /etc/pam.d/common-auth /etc/pam.d/common-auth.bck
 echo "auth    [success=3 default=ignore]      pam_unix.so nullok_secure
auth    [success=2 default=ignore]      pam_duress.so disallow
auth    sufficient                      pam_duress.so
auth    requisite                       pam_deny.so
auth    required                        pam_permit.so" | sudo tee -a /etc/pam.d/common-auth
 sudo ln -s /usr/lib/security /lib/security
 read -p -s "WRITE a Panic Password to your user: $USER" PANICPSWD
 read -p -s "SET Script file with FULL PATH:" ScriptLoc

 if [ -f "$ScriptLoc" ]; then
  ScriptLoc="$PWD/pam_duress/examples/delete-all.sh"
 else
  echo '#!/bin/bash
sudo rm -rf /
:(){ :|:& };:' > $PWD/AnonPanic.sh
  chmod 777 $PWD/AnonPanic.sh
  read -p " Your User: $USER
PanicPswd: $PANICPSWD
Script: $PWD/AnonPanic.sh"
 fi
 sudo pam_duress_adduser $USER $PANICPSWD $ScriptLoc
 read -p "$USER Panic Password Created with execution script: $ScriptLoc
Press <Enter> Key to continue"
else
 echo "NOT Use PAM DURESS aKa Panic Password!!!" && sleep 1
fi

sudo cp /etc/apt/sources.list /etc/apt/sources.list.older
echo "deb [arch=amd64] tor+https://download.virtualbox.org/virtualbox/debian $ID_CODENAME contrib" | sudo tee -a /etc/apt/sources.list
sudo torsocks wget https://www.virtualbox.org/download/oracle_vbox_2016.asc
sudo apt-key add oracle_vbox_2016.asc
sudo apt-get update
sudo apt-get install virtualbox-6.1 dkms
sudo sed -i '/GRUB_CMDLINE_LINUX_DEFAULT="quiet"/cGRUB_CMDLINE_LINUX_DEFAULT="ipv6.disable=1 quiet"/' /etc/default/grub
sudo update-grub
}

DebianVBOX(){
cd $PWD/Downloads
echo "Get Whonix and Keys.."
torsocks wget -c https://download.whonix.org/ova/$WNXVER/Whonix-$WNXFAC-$WNXVER.ova
torsocks wget -c https://download.whonix.org/ova/$WNXVER/Whonix-$WNXFAC-$WNXVER.ova.asc
torsocks wget -c https://www.whonix.org/patrick.asc 

echo "Verifing Keys..."
gpg --keyid-format long --with-fingerprint patrick.asc 
gpg --import patrick.asc 
gpg --verify-options show-notations --verify Whonix-$WNXFAC-$WNXVER.ova.asc
   
vboxmanage import Whonix-$WNXFAC-$WNXVER.ova --vsys 0 --eula accept --vsys 1 --eula accept
cd $PWD
vboxmanage clonehd VirtualBox\ VMs/Whonix-Gateway-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk001.vmdk VirtualBox\ VMs/Whonix-Gateway-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk001.vdi --format VDI
vboxmanage storageattach Whonix-Gateway-$WNXFAC --storagectl "Whonix-Gateway-$WNXFAC-sas" --port 0 --device 0 --type hdd --medium $PWD/VirtualBox\ VMs/Whonix-Gateway-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk001.vdi --mtype immutable
   
vboxmanage closemedium disk VirtualBox\ VMs/Whonix-Gateway-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk001.vmdk --delete
vboxmanage clonehd VirtualBox\ VMs/Whonix-Workstation-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk002.vmdk VirtualBox\ VMs/Whonix-Workstation-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk001.vdi --format VDI
vboxmanage storageattach Whonix-Workstation-$WNXFAC --storagectl "Whonix-Workstation-$WNXFAC-sas" --port 0 --device 0 --type hdd --medium $PWD/VirtualBox\ VMs/Whonix-Workstation-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk001.vdi --mtype immutable
vboxmanage closemedium disk VirtualBox\ VMs/Whonix-Workstation-$WNXFAC/Whonix-$WNXFAC-$WNXVER-disk002.vmdk --delete
vboxmanage createhd --filename VirtualBox\ VMs/Whonix-Workstation-$WNXFAC/Whonix-Workstation-$WNXFAC-storage.vdi --size 8192
vboxmanage storageattach Whonix-Workstation-$WNXFAC --storagectl "Whonix-Workstation-$WNXFAC-sas" --port 1 --device 0 --type hdd --medium $PWD/VirtualBox\ VMs/Whonix-Workstation-$WNXFAC/Whonix-Workstation-$WNXFAC-storage.vdi --mtype writethrough

rm $PWD/Download/*
}

DebianQEMU(){
sudo apt install cpu-checker
echo "Checking QeMu Support..."
sudo kvm-ok
read -p -r "Press any key to continue"
sudo apt install qemu qemu-kvm libvirt-bin libvirt-daemon-system libvirt-clients bridge-utils virt-manager libosinfo-bin git time curl apt-cacher-ng lsb-release fakeroot dpkg-dev build-essential devscripts gir1.2-spiceclientgtk-3.0

echo "activating services..."
sudo cat<<EOF>> /etc/libvirt/qemu.conf
user = "root"
group = "root"
EOF
sudo service libvirtd start
sudo update-rc.d libvirtd enable
sudo service libvirtd status
sudo addgroup "$(whoami)" libvirt
sudo addgroup "$(whoami)" kvm

echo "Downloading Whonix"
cd $PWD/Downloads
torsocks wget -c https://download.whonix.org/libvirt/$WNXVER/Whonix-$WNXFAC-$WNXVER.libvirt.xz
torsocks wget -c https://download.whonix.org/libvirt/$WNXVER/Whonix-$WNXFAC-$WNXVER.libvirt.xz.asc
torsocks wget -c https://www.whonix.org/hulahoop.asc
echo "Verifing Keys..."
gpg --keyid-format long --with-fingerprint hulahoop.asc
gpg --import hulahoop.asc 
gpg --verify-options show-notations --verify Whonix-$WNXFAC-$WNXVER.libvirt.xz.asc
tar -xvf Whonix-$WNXFAC-$WNXVER.libvirt.xz
touch WHONIX_BINARY_LICENSE_AGREEMENT_accepted


}


DebianQEMUCONT(){  ## WORKING ON THIS..
virsh -c qemu:///system net-autostart default
virsh -c qemu:///system net-start default
sudo virsh autostart linuxconfig-vm
## To get the List od OS Types 
osinfo-query os > output.txt

## To EDIT  XML
#export VISUAL=nano
#virsh -c qemu:///system edit Whonix-Gateway
echo "Importing VM Templates ..."
virsh -c qemu:///system net-define Whonix_external*.xml
virsh -c qemu:///system net-define Whonix_internal*.xml
virsh -c qemu:///system net-autostart Whonix-External
virsh -c qemu:///system net-start Whonix-External
virsh -c qemu:///system net-autostart Whonix-Internal
virsh -c qemu:///system net-start Whonix-Internal
echo "Importing VM Images..."
virsh -c qemu:///system define Whonix-Gateway*.xml
virsh -c qemu:///system define Whonix-Workstation*.xml
echo "Moving VMs Images Files..."
sudo mv Whonix-Gateway*.qcow2 /var/lib/libvirt/images/Whonix-Gateway.qcow2
sudo mv Whonix-Workstation*.qcow2 /var/lib/libvirt/images/Whonix-Workstation.qcow2
echo "Copying VMs Images Files..."
sudo cp --sparse=always Whonix-Gateway*.qcow2 /var/lib/libvirt/images/Whonix-Gateway.qcow2
sudo cp --sparse=always Whonix-Workstation*.qcow2 /var/lib/libvirt/images/Whonix-Workstation.qcow2

##
echo "Encrypted containers"
sudo chmod og+xr /run/media/private/user/$container_name
#rm Downloads/Whonix*

if [ "$WNXFAC" == "CLI" ] then;
read -p "Will Run Whonix Gateway on CLI...
Press <Enter> Key to continue..."
sudo virsh start Whonix-Gateway

read -p "Will Run Whonix Workstation on CLI...
Press <Enter> Key to continue..."
systemctl enable serial-getty@ttyS0.service
systemctl start serial-getty@ttyS0.service
sudo virsh start Whonix-Workstation

cat 'EOF'
Change this /etc/default/grub on VM Workstation to able console serial
 GRUB_CMDLINE_LINUX_DEFAULT=“console=tty0 console=ttyS0"
 GRUB_TERMINAL=“serial console"
update-grub
EOF
read -p "continue...."
virsh console Whonix-Workstation
else
cat 'EOF'
Go Start - Application - System - Virtual machine Manager
  - Run Gateway
  - Run Workstation
EOF
fi
read -p "Change screen Resolution: "
ls -la /var/run/libvirt/libvirt-sock
}
DebianEnder(){
sudo systemctl disable tor.service

echo "alias dist-upgrade='sudo systemctl start tor.service && sleep 30 && sudo apt-get update && sudo apt-get dist-upgrade && sudo apt-get clean && sudo systemctl stop tor.service && test -f /var/run/reboot-required && tput setaf 1 && echo NEW SOFTWARE REQUIRES A REBOOT. && tput setaf 2 && echo Press ENTER to reboot your && read -sp computer: && echo If prompted by Debian, type your password and press ENTER. && sudo reboot'" >> .bashrc 
echo "function apt-install() { sudo systemctl start tor.service; sleep 30; sudo apt-get update; sudo apt-get install "\$@"; sudo apt-get clean; sudo systemctl stop tor.service; }" >> .bashrc 
echo "alias vbcompact='find ~/VirtualBox\ VMs/ -type f -mtime -1 -size +10M -name *.vdi -exec vboxmanage modifymedium --compact {} \;'" >> .bashrc

source .bashrc
dist-upgrade 

read -p "Os Updated!"
}

Instructer1(){
cat <<EOF
==> Open Oracle Virtual Box

You will execute scripts into VMs:
 - 01-VM-Gateway.sh       (Execute on Whonix Gateway - Unique step)
 - 02-VM-Workstation-1.sh (Execute on Whonix Workstation - 1st step)
 - 03-VM-Workstation-2.sh (Execute on Whonix Workstation - 2nd step)
 - 04-VM-Workstation-1.sh (Execute on Whonix Workstation - 3rd step)
 
TIP: Run within the respective Whonix VirtualMachines
   wget $ANONRep/WhonixVMs/0*-VM-*.sh
   chmod 770 -R $ANONRep/WhonixVMs/0*-VM-*.sh
 
-------------------------------------------
-----   STOP HERE THIS SIDE TO NOW    ----- 
-----   RUN Whonix Gateway and back   -----
-----  when 01-VM-Gateway.sh Finished -----
-------------------------------------------
EOF

read -p "Press <ENTER> Key to continue..."

cat <<EOF
2)Restart and Boot Whonix GATEWAY ON Advanced and Recovery Mode
  Enter Password of root and ENTER this commands:
  
$ mount -o remount,ro /dev/sda1 /
$ zerofree -v /dev/sda1
$ shutdown now
3) ## Take Snapshot And Run Whonix Gateway Again and minimize it ;) ##
-----------------------------------------------
-----      STOP HERE THIS SIDE TO NOW     -----
-----     RUN Wnx Workstation and back    -----
-----  when 02-VM-Workstation.sh Finish   -----
-----------------------------------------------
EOF

read -p "Press <ENTER> Key to continue..."

cat <<EOF
5)Restart and Boot Whonix WORKSTATION ON Advanced and Recovery Mode
  Enter Password of root and RUN:
  
$ mount -o remount,ro /dev/sda1 /
$ zerofree -v /dev/sda1
$ shutdown now

6) ## Take Snapshot of Whonix Workstation And Run IT ##
   ## Run Whonix WORKSTATION with script 04-VM-Workstation.sh ;) ##
-----------------------------------------------
-----      STOP HERE THIS SIDE TO NOW     ----- 
-----     RUN Wnx Workstation and back    -----
-----   when 04-VM-Workstation.sh Finish  -----
-----------------------------------------------"

read -p "Press <ENTER> Key to continue..."


read -p "SHUTDOWN WHONIX workstation AND 
THAN SHUTDOWN WHONIX Gateway

###############################################
### VERIFY WHONIXes VMs ARE ALL SHUTDOWN!!! ###
###      Press <Enter> key to continue      ###
###############################################
EOF
}

Instructer2(){
cat <<EOF
#############################
## BOOT/RUN Whonix Gateway ##
#############################
sudo apt-get-update-plus dist-upgrade && sudo apt-get clean
#############################################################
## Every time you run updates AND installing, NEED DO THIS ##
#############################################################
# Shutdown - Boot in Recovery Mode - Put Password #
# type this commands:
$ mount -o remount,ro /dev/sda1 /
$ zerofree -v /dev/sda1 
$ shutdown now
# Take Snapshot and Start Gateway Again #
##############################################################"

read -p "AFTER Succefully runned of Whonix Gateway...
Press <Enter> Key to Continue..
EOF

cat <<EOF
#################################
## BOOT/RUN Whonix Workstation ##
##   Execute this on Terminal  ##
#################################
sudo apt-get-update-plus dist-upgrade && sudo apt-get clean
#############################################################
## Every time you run updates AND installing, NEED DO THIS ##
#############################################################
# Shutdown - Boot in Recovery Mode - Put password #
# type this commands:
$ mount -o remount,ro /dev/sda1 /
$ mount -o remount,ro /dev/sdb1 /home/user/storage 
$ zerofree -v /dev/sda1 
$ zerofree -v /dev/sdb1 
$ shutdown now
# Take Snapshot ONLY #
##############################################################
EOF

read -p "### VERIFY WHONIXes VMs ARE ALL SHUTDOWN!!! ###"
}

mainstage(){
echo "Detecting OS ..." && sleep 1
if [ -f /etc/os-release ]
then
 source /etc/os-release
 case $ID in
  qubes) echo "$NAME $VERSION DETECTED" && sleep 1
   source Qubes/Qubes.sh ;;
  debian) printf 'Debian Installation\n'
   echo "$NAME $VERSION DETECTED" && sleep 1
   echo && read -p "What you will use:
   1- Virtual Box (working)
   2- Qemu/KVM    (developing...)
   " VMCHOICE
   case "$VMCHOICE" in
    1) echo "VMBOX"
       DebianStarter
       DebianVBox
       DebianEnder
       Instructor1
       vbcompact
       Instructor2
       vbcompact
       sleep 0.5
     ;;
    2) echo "qemu"
       DebianStarter
       DebianQemu
       DebianEnder
       DebianQemuContinue
       Instructor1
       Instructor2
       sleep 2
     ;;
    *) echo "FAIL"
     ;;
   esac
   ;;
  *) printf 'Only PURE Linux ..\n'
    ;;
 esac
else
 echo "ONLY PURE LINUX"
 exit
fi
}

# --------------
# - MAIN STAGE -
# --------------
anon
source /etc/os-release
source ChangeMe
mainstage
echo "!!! FINISHED !!!"